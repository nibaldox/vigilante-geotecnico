<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vigilante Geotécnico</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
  <style>
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#0d1117; color:#e6edf3; }
    .wrap { display: grid; grid-template-columns: 2fr 1fr; gap: 12px; padding: 12px; }
    .card { background: #161b22; border:1px solid #30363d; border-radius: 8px; box-shadow: none; padding: 12px; }
    .log { max-height: 80vh; overflow: auto; }
    .msg { border-bottom: 1px solid #30363d; padding: 8px 0; }
    .msg .time { color: #8b949e; font-size: 12px; }
    .state { font-weight: 600; }
    .state.NORMAL { color: #2ea043; }
    .state.ALERTA { color: #d29922; }
    .state.ALARMA { color: #f85149; }
    header { display:flex; align-items:center; gap:12px; padding:8px 12px; border-bottom:1px solid #30363d; background:#0d1117; position:sticky; top:0; z-index:1; flex-wrap: wrap; }
    header .title { font-weight:700; }
    header .meta { color:#8b949e; font-size:12px; }
    header .meta .badge { padding:2px 6px; border-radius:6px; background:#30363d; margin-left:6px; color:#e6edf3; }
    header .actions { margin-left:auto; display:flex; gap:8px; }
    button.reset { background:#21262d; color:#e6edf3; border:1px solid #30363d; padding:6px 10px; border-radius:6px; cursor:pointer; }
    button.reset:hover { background:#30363d; }
    button.zoom { background:#21262d; color:#e6edf3; border:1px solid #30363d; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:12px; }
    button.zoom:hover { background:#30363d; }
    button.zoom:active { background:#484f58; }
    .zoom-controls { display:flex; gap:4px; margin-right:12px; }
    .chart-container { position:relative; width:100%; height:400px; }
    #chart { max-height:400px; }

    /* Media queries para responsive design */
    @media (max-width: 1024px) {
      .wrap {
        grid-template-columns: 1fr;
        gap: 8px;
        padding: 8px;
      }
      .chart-container {
        height: 300px;
      }
      #chart {
        max-height: 300px;
      }
    }

    @media (max-width: 768px) {
      .wrap {
        grid-template-columns: 1fr;
        gap: 6px;
        padding: 6px;
      }
      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
        padding: 8px;
      }
      header .actions {
        margin-left: 0;
        width: 100%;
        justify-content: space-between;
      }
      .zoom-controls {
        margin-right: 0;
        gap: 2px;
      }
      button.zoom {
        padding: 3px 6px;
        font-size: 11px;
      }
      button.reset {
        padding: 4px 8px;
        font-size: 12px;
      }
      .chart-container {
        height: 250px;
      }
      #chart {
        max-height: 250px;
      }
      .log {
        max-height: 200px;
      }
      .meta {
        font-size: 11px;
      }
    }

    @media (max-width: 480px) {
      header {
        padding: 6px;
      }
      header .title {
        font-size: 16px;
      }
      .wrap {
        padding: 4px;
        gap: 4px;
      }
      .card {
        padding: 8px;
      }
      .chart-container {
        height: 200px;
      }
      #chart {
        max-height: 200px;
      }
      .log {
        max-height: 150px;
      }
      .msg {
        padding: 6px 0;
        font-size: 12px;
      }
      .msg .time {
        font-size: 10px;
      }
      .zoom-controls {
        gap: 1px;
      }
      button.zoom {
        padding: 2px 4px;
        font-size: 10px;
      }
      button.reset {
        padding: 3px 6px;
        font-size: 11px;
      }
    }

    @media (max-width: 320px) {
      header .title {
        font-size: 14px;
      }
      .meta {
        font-size: 10px;
      }
      .chart-container {
        height: 180px;
      }
      #chart {
        max-height: 180px;
      }
      .log {
        max-height: 120px;
      }
      .instructions {
        display: none; /* Ocultar instrucciones en pantallas muy pequeñas */
      }
    }

    /* Mejoras para touch devices */
    @media (hover: none) and (pointer: coarse) {
      button.zoom {
        min-height: 44px; /* Touch target mínimo */
        min-width: 44px;
      }
      button.reset {
        min-height: 44px;
        min-width: 44px;
      }
    }
  </style>
  <script>
    let chart, shaded = [];
    let currentPoints = [];
    const DEMO = new URLSearchParams(location.search).get('demo') === '1';
    let anchorMs = Date.now();
    function parseTs(ts){
      if(!ts) return NaN;
      const iso = ts.includes('T') ? ts : ts.replace(' ', 'T') + (ts.length===16?':00':'');
      const d = new Date(iso);
      return d.getTime();
    }
    function filterByAnchor(points){
      const filtered = points.filter(p => {
        const t = parseTs(p.time);
        return isFinite(t) ? (t >= anchorMs) : true;
      });
      return filtered.length ? filtered : points;
    }
    async function fetchEvents() {
      const res = await fetch('/api/events?limit=5000');
      const json = await res.json();
      return json.events || [];
    }
    function getDemoEvents() {
      const now = new Date();
      const pts = [];
      let disp = 0;
      for (let i = 0; i < 120; i++) {
        const t = new Date(now - (119 - i) * 120000);
        const ts = t.toISOString().slice(0,16).replace('T',' ');
        const noise = (Math.sin(i/7) + Math.sin(i/13)) * 0.05;
        let step = 0.03 + noise;
        let state = 'NORMAL';
        if (i > 40 && i < 55) { step += 0.15; state = 'ALERTA'; }
        if (i > 85 && i < 95) { step += 0.35; state = 'ALARMA'; }
        disp += step;
        const vel_mm_hr = step * 30;
        let rationale = 'Variación leve; sin señales relevantes.';
        if (state === 'ALERTA') rationale = 'Aumento moderado y acumulado reciente sobre umbral; vigilancia reforzada.';
        if (state === 'ALARMA') rationale = 'Incremento acelerado con acumulado alto; acciones inmediatas recomendadas.';
        pts.push({ time: ts, disp_mm: +disp.toFixed(3), vel_mm_hr: +vel_mm_hr.toFixed(3), state, rationale, llm_level: state });
      }
      return pts;
    }
    function computeEMA(arr, span){
      if (!arr || !arr.length) return [];
      const k = 2 / (span + 1);
      const out = new Array(arr.length).fill(null);
      let ema = arr[0];
      out[0] = ema;
      for (let i=1;i<arr.length;i++){
        const v = arr[i];
        if (v == null) { out[i] = out[i-1]; continue; }
        ema = v * k + ema * (1 - k);
        out[i] = ema;
      }
      return out;
    }
    function estimateDeltaMinutes(labels){
      if (!labels || labels.length < 2) return 2;
      const times = labels.map(parseTs).filter(t => Number.isFinite(t));
      const diffs = [];
      for (let i=1;i<times.length;i++){
        const d = (times[i] - times[i-1]) / 60000;
        if (Number.isFinite(d) && d > 0) diffs.push(d);
      }
      if (!diffs.length) return 2;
      diffs.sort((a,b)=>a-b);
      return diffs[Math.floor(diffs.length/2)] || 2;
    }
    function computeShadedRegions(points) {
      const regions = [];
      if (!points.length) return regions;
      let start = 0; let cur = points[0].state || 'NORMAL';
      for (let i = 1; i < points.length; i++) {
        const st = points[i].state || 'NORMAL';
        if (st !== cur) {
          if (cur !== 'NORMAL') regions.push({ state: cur, t0: points[start].time, t1: points[i-1].time });
          start = i; cur = st;
        }
      }
      if (cur !== 'NORMAL') regions.push({ state: cur, t0: points[start].time, t1: points[points.length-1].time });
      return regions;
    }
    function upsertChart(points) {
      currentPoints = points.slice();
      const labels = points.map(p => p.time);
      const series = points.map(p => p.disp_mm);
      const dtMin = estimateDeltaMinutes(labels);
      const span1h = Math.max(1, Math.round(60 / dtMin));
      const span3h = Math.max(1, Math.round(180 / dtMin));
      const span12h = Math.max(1, Math.round(720 / dtMin));
      const ema1h = computeEMA(series, span1h);
      const ema3h = computeEMA(series, span3h);
      const ema12h  = computeEMA(series, span12h);
      shaded = computeShadedRegions(points);
      if (!chart) {
        const ctx = document.getElementById('chart').getContext('2d');
        chart = new Chart(ctx, {
          type: 'line',
          data: { labels, datasets: [
            { label: 'Deformación acumulada (mm)', data: series, borderColor: '#58a6ff', /*backgroundColor: 'rgba(88,166,255,.15)',*/ fill:false, tension: 0.25, pointRadius: 0, borderWidth: 1.8, spanGaps: true },
            { label: 'EMA 1h', data: ema1h, borderColor: '#9cdcfe', tension: 0.25, pointRadius: 0, borderWidth: 1.2, fill:false, spanGaps: true },
            { label: 'EMA 3h', data: ema3h, borderColor: '#c5e1a5', tension: 0.25, pointRadius: 0, borderWidth: 1.1, fill:false, spanGaps: true },
            { label: 'EMA 12h',  data: ema12h,  borderColor: '#f5b971', tension: 0.25, pointRadius: 0, borderWidth: 1.0, fill:false, spanGaps: true }
          ] },
          options: {
            responsive: true,
            animation: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
              zoom: {
                zoom: {
                  wheel: {
                    enabled: true,
                    speed: 0.05,
                    modifierKey: 'ctrl',
                  },
                  pinch: {
                    enabled: true,
                  },
                  drag: {
                    enabled: true,
                    backgroundColor: 'rgba(88, 166, 255, 0.1)',
                    borderColor: '#58a6ff',
                    borderWidth: 1,
                  },
                  mode: 'xy',
                  onZoomStart({chart}) {
                    chart.render();
                  },
                  onZoomComplete({chart}) {
                    console.log('Zoom:', chart.getZoomLevel());
                  }
                },
                pan: {
                  enabled: true,
                  mode: 'xy',
                  modifierKey: 'shift',
                  onPanStart({chart}) {
                    chart.render();
                  },
                  onPanComplete({chart}) {
                    console.log('Pan completado');
                  }
                },
                limits: {
                  x: { min: 'original', max: 'original', minRange: 3600000 }, // mínimo 1 hora
                  y: { min: 'original', max: 'original' }
                },
                transition: {
                  duration: 300,
                  easing: 'easeInOutQuart'
                }
              },
              tooltip: {
                callbacks: {
                  title(items){ return items[0]?.label || ''; },
                  label(ctx){
                    const y = ctx.parsed.y;
                    const name = ctx.dataset.label || '';
                    if (name.startsWith('Deformación')) return ` ${name}: ${y?.toFixed(3)} mm`;
                    return ` ${name}: ${y?.toFixed(3)} mm`;
                  },
                  afterBody(items){
                    const idx = items[0]?.dataIndex ?? 0;
                    const p = currentPoints[idx] || {};
                    const extra = [];
                    if (p.vel_mm_hr != null) extra.push(` vel: ${Number(p.vel_mm_hr).toFixed(3)} mm/hr`);
                    if (p.state) extra.push(` estado: ${p.state}`);
                    return extra.join('\n');
                  }
                }
              }
            },
            scales: {
              x: {
                ticks: {
                  maxTicksLimit: window.innerWidth < 768 ? 5 : 8,
                  color:'#8b949e',
                  font: {
                    size: window.innerWidth < 480 ? 10 : 12
                  }
                },
                grid:{ color:'rgba(240,246,252,0.08)' },
                type: 'time',
                time: {
                  displayFormats: {
                    hour: 'HH:mm',
                    day: 'dd/MM',
                    minute: 'HH:mm'
                  }
                }
              },
              y: {
                ticks:{
                  color:'#8b949e',
                  font: {
                    size: window.innerWidth < 480 ? 10 : 12
                  }
                },
                grid:{ color:'rgba(240,246,252,0.08)' },
                title: {
                  display: true,
                  text: 'mm',
                  color:'#8b949e',
                  font: {
                    size: window.innerWidth < 480 ? 10 : 12
                  }
                }
              }
            },
            responsive: true,
            maintainAspectRatio: false
          },
          plugins: [{
            id: 'region-shader',
            beforeDraw(c) {
              const ctx2 = c.ctx; const xScale = c.scales.x; const yScale = c.scales.y;
              if (!xScale || !yScale) return;
              const top = yScale.getPixelForValue(yScale.max);
              const bottom = yScale.getPixelForValue(yScale.min);
              shaded.forEach(r => {
                const x0 = xScale.getPixelForValue(r.t0);
                const x1 = xScale.getPixelForValue(r.t1);
                if (!isFinite(x0) || !isFinite(x1)) return;
                ctx2.save();
                ctx2.fillStyle = r.state === 'ALARMA' ? 'rgba(248,81,73,.14)' : 'rgba(210,153,34,.14)';
                ctx2.fillRect(Math.min(x0,x1), top, Math.abs(x1-x0), bottom-top);
                ctx2.restore();
              });
            }
          }]
        });

        // Agregar doble clic para reset zoom
        const canvas = document.getElementById('chart');
        canvas.addEventListener('dblclick', function(event) {
          if (chart) {
            chart.resetZoom();
          }
        });

      } else {
        chart.data.labels = labels;
        chart.data.datasets[0].data = series;
        chart.data.datasets[1].data = ema1h;
        chart.data.datasets[2].data = ema3h;
        chart.data.datasets[3].data = ema12h;
        chart.update();
      }
    }
    function renderMessages(points) {
      const box = document.getElementById('msgs');
      box.innerHTML = '';
      points.slice().reverse().forEach(p => {
        const div = document.createElement('div');
        div.className = 'msg';
        const badge = p.state ? `<span class="state ${p.state}">${p.state}</span>` : '';
        const model = p.llm_level ? `<span class="meta"> | LLM: ${p.llm_level}</span>` : '';
        div.innerHTML = `<div class="time">${p.time || ''}</div>
          <div>${badge}${model}</div>
          <div>${(p.rationale || '').toString().slice(0, 450)}</div>`;
        box.appendChild(div);
      });
    }
    async function tick() {
      try {
        let evs;
        if (DEMO) {
          evs = getDemoEvents();
          document.getElementById('mode').textContent = 'DEMO';
        } else {
          evs = await fetchEvents();
          document.getElementById('mode').textContent = 'LIVE';
        }
        const filtered = filterByAnchor(evs);
        upsertChart(filtered);
        renderMessages(filtered);
      } catch (e) { console.error(e); }
      setTimeout(tick, 2500);
    }
    function onReset(){ anchorMs = Date.now(); chart = null; shaded = []; }
    function zoomIn() {
      if (chart) {
        chart.zoom(1.5);
      }
    }
    function zoomOut() {
      if (chart) {
        chart.zoom(0.67);
      }
    }
    function resetZoom() {
      if (chart) {
        chart.resetZoom();
      }
    }

    // Función para actualizar responsive features
    function updateResponsiveFeatures() {
      if (chart) {
        // Actualizar ticks según el ancho de pantalla
        chart.options.scales.x.ticks.maxTicksLimit = window.innerWidth < 768 ? 5 : 8;
        chart.options.scales.x.ticks.font.size = window.innerWidth < 480 ? 10 : 12;
        chart.options.scales.y.ticks.font.size = window.innerWidth < 480 ? 10 : 12;
        chart.options.scales.y.title.font.size = window.innerWidth < 480 ? 10 : 12;
        chart.update();
      }

      // Actualizar instrucciones según el ancho de pantalla
      const instructions = document.querySelector('.instructions');
      if (instructions) {
        if (window.innerWidth < 480) {
          instructions.textContent = 'Zoom: Ctrl+rueda | Reset: doble clic';
        } else if (window.innerWidth < 768) {
          instructions.textContent = 'Zoom: Ctrl+rueda | Pan: Shift+drag | Reset: doble clic';
        } else {
          instructions.textContent = 'Zoom: Ctrl+rueda | Pan: Shift+drag | Zoom: botones | Reset: doble clic';
        }
      }
    }
    function fitToData() {
      if (chart) {
        chart.resetZoom();
        // Ajustar automáticamente a todos los datos visibles
        setTimeout(() => {
          const filtered = filterByAnchor(currentPoints.length ? currentPoints : (DEMO ? getDemoEvents() : []));
          if (filtered.length > 0) {
            const times = filtered.map(p => parseTs(p.time)).filter(t => Number.isFinite(t));
            if (times.length > 1) {
              const minTime = Math.min(...times);
              const maxTime = Math.max(...times);
              const values = filtered.map(p => p.disp_mm).filter(v => typeof v === 'number');
              const minValue = Math.min(...values);
              const maxValue = Math.max(...values);
              const padding = 0.1; // 10% de padding

              // Aplicar zoom programático
              chart.zoomScale('x', {
                min: minTime,
                max: maxTime
              });
              chart.zoomScale('y', {
                min: minValue - (maxValue - minValue) * padding,
                max: maxValue + (maxValue - minValue) * padding
              });
              chart.update();
            }
          }
        }, 100);
      }
    }
    window.addEventListener('DOMContentLoaded', () => {
      document.getElementById('resetBtn').addEventListener('click', onReset);
      document.getElementById('zoomInBtn').addEventListener('click', zoomIn);
      document.getElementById('zoomOutBtn').addEventListener('click', zoomOut);
      document.getElementById('resetZoomBtn').addEventListener('click', resetZoom);
      document.getElementById('fitDataBtn').addEventListener('click', fitToData);

      // Inicializar features responsive
      updateResponsiveFeatures();

      tick();
    });

    // Event listener para resize de ventana
    window.addEventListener('resize', updateResponsiveFeatures);
  </script>
</head>
<body>
  <header>
    <div class="title">Vigilante Geotécnico</div>
    <div class="meta">Fuente: registros.jsonl · Actualiza cada ~2.5 s <span id="mode" class="badge"></span></div>
    <div class="meta instructions">Zoom: Ctrl+rueda | Pan: Shift+drag | Zoom: botones | Reset: doble clic</div>
    <div class="actions">
      <div class="zoom-controls">
        <button id="zoomInBtn" class="zoom" title="Zoom In">+</button>
        <button id="zoomOutBtn" class="zoom" title="Zoom Out">−</button>
        <button id="resetZoomBtn" class="zoom" title="Reset Zoom">⌂</button>
        <button id="fitDataBtn" class="zoom" title="Fit to Data">⚡</button>
      </div>
      <button id="resetBtn" class="reset">Reset</button>
    </div>
  </header>
  <div class="wrap">
    <div class="card">
      <div class="chart-container">
        <canvas id="chart" height="400"></canvas>
      </div>
    </div>
    <div class="card log">
      <h3>Mensajes LLM</h3>
      <div id="msgs"></div>
    </div>
  </div>
</body>
</html>


